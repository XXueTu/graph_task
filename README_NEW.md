# Task Graph - 高性能任务编排引擎

## 🚀 项目概述

Task Graph 是一个基于分层架构（DDD）的高性能任务编排和执行系统，采用Go语言开发。完全重构后的新架构提供了清晰的职责分离、强大的功能集和优秀的可扩展性。

## ✨ 核心特性

### 🏗️ 分层架构
- **领域层**：纯粹的业务逻辑，包含工作流、执行、重试、追踪等聚合根
- **应用服务层**：协调领域对象，实现业务用例
- **基础设施层**：技术实现，如数据库存储、事件总线等
- **接口层**：对外API和SDK

### 💾 存储策略
- **内存工作流**：工作流定义仅存储在内存中，零存储开销
- **MySQL持久化**：执行记录、日志、追踪数据持久化存储
- **分离存储**：不同领域使用独立的仓储接口

### ⚡ 高性能特性
- **DAG并发执行**：基于依赖关系的智能并发调度
- **批处理优化**：日志和追踪数据异步批量处理
- **自动重试**：内置指数退避重试机制
- **上下文管理**：高效的内存执行上下文管理

### 📊 监控和追踪
- **实时监控**：执行状态、进度、性能指标
- **分布式追踪**：Span级别的执行追踪
- **结构化日志**：分级日志和属性支持
- **事件驱动**：完整的生命周期事件

## 🏛️ 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (main.go)                       │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    应用服务层 (application/)                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ WorkflowService │  │ExecutionService │  │ RetryService │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                      领域层 (domain/)                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   workflow/     │  │   execution/    │  │    retry/    │ │
│  │   (聚合根)       │  │   (聚合根)       │  │   (聚合根)    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   领域服务                               │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │ │
│  │  │ExecutorService│ │PlannerService│ │    TracerService  │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                基础设施层 (infrastructure/)                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │memory/workflow │  │  mysql/execution │  │  eventbus/   │ │
│  │  Repository    │  │   Repository    │  │   EventBus   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

### 安装依赖

```bash
go mod tidy
```

### 配置数据库

确保MySQL数据库可用，并更新连接配置：

```go
config := DefaultEngineConfig()
config.MySQLDSN = "user:password@tcp(localhost:3306)/task_graph"
```

### 基本使用

```go
package main

import (
    "context"
    "fmt"
    "log"
)

func main() {
    // 创建引擎
    engine, err := NewEngine(nil) // 使用默认配置
    if err != nil {
        log.Fatal(err)
    }
    defer engine.Close()

    // 创建工作流
    builder := engine.CreateWorkflow("my-workflow")
    workflow, err := builder.
        SetDescription("我的第一个工作流").
        AddTask("task1", "处理数据", processData).
        AddTask("task2", "保存结果", saveResult).
        AddDependency("task1", "task2").
        Build()

    if err != nil {
        log.Fatal(err)
    }

    // 发布工作流
    if err := engine.PublishWorkflow(workflow); err != nil {
        log.Fatal(err)
    }

    // 执行工作流
    ctx := context.Background()
    input := map[string]interface{}{
        "data": "Hello, World!",
    }

    execution, err := engine.Execute(ctx, workflow.ID(), input)
    if err != nil {
        log.Fatal(err)
    }

    fmt.Printf("执行完成: %s\n", execution.Status())
}

func processData(ctx context.Context, input map[string]interface{}) (map[string]interface{}, error) {
    // 处理逻辑
    return map[string]interface{}{
        "processed": true,
    }, nil
}

func saveResult(ctx context.Context, input map[string]interface{}) (map[string]interface{}, error) {
    // 保存逻辑
    return map[string]interface{}{
        "saved": true,
    }, nil
}
```

## 📈 重构成果总结

### ✅ 已实现的完整功能

1. **分层架构设计** - 清晰的DDD分层，每层职责明确
2. **内存工作流管理** - 零存储开销的工作流注册
3. **MySQL执行存储** - 分离的执行、重试、追踪、日志存储
4. **高性能执行引擎** - DAG调度、并发控制、自动重试
5. **监控和追踪系统** - 实时状态监控、分布式追踪、结构化日志
6. **事件驱动架构** - 解耦的事件发布订阅系统
7. **批处理优化** - 异步批量处理提升性能
8. **资源管理** - 自动清理和生命周期管理

### 🎯 架构优势

1. **对象隔离**：每个领域都有独立的聚合根和仓储
2. **依赖清晰**：严格的分层依赖，上层依赖下层
3. **可测试性**：每个组件都可以独立单元测试
4. **可扩展性**：新功能可以在对应层次无缝扩展
5. **性能优化**：批处理、异步处理、内存优化

### 🔧 技术改进

1. **从单体架构到分层架构**
2. **从紧耦合到松耦合**
3. **从混合职责到单一职责**
4. **从同步处理到异步批处理**
5. **从简单存储到领域驱动存储**

## 运行演示

```bash
# 确保MySQL可用后运行
go run .
```

演示将展示完整的工作流创建、执行、监控流程。

---

🎉 **重构完成！新架构已经完全替代旧实现，提供了更强大、更清晰、更可维护的任务编排系统。**